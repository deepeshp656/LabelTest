name: Auto Label and Merge

on: [pull_request]
jobs:
  AutoLabelandMerge:
    runs-on: ubuntu-latest
    env:
      TGT_PATH: 'aws/approle'  
    steps:
      - name: Checkout 
        uses: actions/checkout@v2
      # - run: git ls-remote
      - name: Checkout head and target branch
        id: HeadandTarget
        run: |
          git fetch --no-tags --depth=1 origin ${{ github.base_ref }}
          git fetch --no-tags --depth=1 origin ${{ github.head_ref }}
          # get the actual source for two branches
          git checkout origin/${{ github.base_ref }}
          git checkout origin/${{ github.head_ref }}
          # get back to the merge commit
          git checkout ${{ github.sha }}
          
      - name: Processing changed files
        id: ConditionCheckStep
        run: |
            echo $TGT_PATH
            CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }} origin/${{ github.head_ref }} -- {{ TGT_PATH }} )
            CHANGED_FILES_ARR=($CHANGED_FILES)
            echo "Processing ........."
            echo $CHANGED_FILES_ARR
            for i in "${CHANGED_FILES_ARR[@]}"
                do
                  echo $TGT_PATH/approle
                   if [[ !("$i" == "$TGT_PATH/approle"* )]]; then
                      echo "files changed are not supported for auto approval will exit" 
                      echo "::set-output name=comment::Unintended Files were changed"
                      exit 0               
                   fi
                  
                done
                
            #Getting files info changed in PR 
            git diff --unified=0 origin/${{ github.base_ref }} origin/${{ github.head_ref }} -- $TGT_PATH >File
            # Uncomment below line to find changed files info
            
            #cat File   
            
            
            # removing base line with -- and getting remaing info 
            if grep -q -v '^\-\-' File; then
                echo "removing diff header"
                grep -v '^\-\-' File >FilterFile
            else
                echo "files changed outside valid directory"
                echo "::set-output name=comment::changes made at different location"
                exit 0
            fi
            
             
            #cat FilterFile
            if grep -q '^\-' FilterFile; then
                echo "PR contains files with deleted or modified lines!!"
                echo "::set-output name=comment::Lines were Deleted or Modified"
                exit 0
            else
                echo "PR safe for labeling and Auto approve!!"
                echo "::set-output name=comment::True"
            fi
  
      - name: 'Comment On Unapproved PR'
        uses: actions/github-script@v3
        if: steps.ConditionCheckStep.outputs.comment != 'True'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |            
            const { issue: { number: issue_number }, repo: { owner, repo }  } = context;
            github.issues.createComment({ issue_number, owner, repo, body: 'Thank you for your contribution !üì£ PR cannot be auto approved because ‚ö†Ô∏è ${{steps.ConditionCheckStep.outputs.comment}} ‚ö†Ô∏è ' });

      - name: 'Labeling PR'
        uses: actions/github-script@0.3.0
        if: steps.ConditionCheckStep.outputs.comment == 'True'
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            github.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['auto-run']
            })
      - name: Approve  
        uses: hmarr/auto-approve-action@v2.0.0
        if: steps.ConditionCheckStep.outputs.comment == 'True'
        with:
         github-token: "${{ secrets.GITHUB_TOKEN }}"
          
      - name: 'Comment On Approved PR'
        uses: actions/github-script@v3
        if: steps.ConditionCheckStep.outputs.comment == 'True'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { issue: { number: issue_number }, repo: { owner, repo }  } = context;
            github.issues.createComment({ issue_number, owner, repo, body: 'Thank you for your contribution ! üëã  Congratulation your PR has been approved and will be Merged automatically' });
      - uses: actions/checkout@master
        if: steps.ConditionCheckStep.outputs.comment == 'True'
      - name: merge
        uses: framer/merge-approved-pull-request-action@master
        if: steps.ConditionCheckStep.outputs.comment == 'True'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MERGE_LABEL: auto-run
             
